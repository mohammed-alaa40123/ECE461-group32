(()=>{"use strict";var e={496:e=>{e.exports=require("aws-sdk")}},n={};function r(t){var o=n[t];if(void 0!==o)return o.exports;var s=n[t]={exports:{}};return e[t](s,s.exports,r),s.exports}r.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return r.d(n,{a:n}),n},r.d=(e,n)=>{for(var t in n)r.o(n,t)&&!r.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},r.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var t={};r.r(t),r.d(t,{handler:()=>we});const o=require("dotenv");var s=r.n(o);const i=require("semver");var a=r.n(i);const c=require("pg");var u=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};s().config();const l=new c.Pool({host:process.env.RDS_HOST||"localhost",user:process.env.RDS_USER||"postgres",password:process.env.RDS_PASSWORD||"password",database:process.env.RDS_DATABASE||"postgres",port:parseInt(process.env.RDS_PORT||"5432"),max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3,ssl:"true"===process.env.USE_SSL&&{rejectUnauthorized:!1}}),d=l,p=(e,n)=>u(void 0,void 0,void 0,(function*(){const r=[e.ID,e.Name,e.Owner,e.Version,n.URL||null,n.debloat||!1,n.JSProgram||null];return(yield l.query("\n    INSERT INTO packages (id, name,owner, version, url, debloat, js_program)\n    VALUES ($1, $2, $3, $4, $5, $6, $7)\n    RETURNING *;\n  ",r)).rows[0]}));var E=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const g=new(r(496).S3),f=(e,n)=>E(void 0,void 0,void 0,(function*(){const r={Bucket:process.env.S3_BUCKET,Key:`packages/${e}.zip`,Body:n};yield g.putObject(r).promise()})),y=(e,n)=>({statusCode:e,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),m=require("jsonwebtoken");var _=r.n(m);const h=e=>{return n=void 0,r=void 0,o=function*(){const n=e["X-Authorization"]||e["x-authorization"];if(!n)throw{statusCode:403,message:"Missing Authentication Token"};const r=n.split(" ");if(2!==r.length||"bearer"!==r[0].toLowerCase())throw{statusCode:403,message:"Invalid Authentication Token"};const t=r[1];try{const e=_().verify(t,process.env.JWT_SECRET),n="SELECT is_admin FROM users WHERE id = $1",r=yield d.query(n,[e.sub]);e.isAdmin=r.rows[0].is_admin;const o="\n      SELECT g.name\n      FROM user_groups ug\n      JOIN groups g ON ug.group_id = g.id\n      WHERE ug.user_id = $1\n    ",s=yield d.query(o,[e.sub]);e.groups=s.rows.map((e=>e.name));const i="\n      SELECT p.name\n      FROM user_permissions up\n      JOIN permissions p ON up.permission_id = p.id\n      WHERE up.user_id = $1\n    ",a=yield d.query(i,[e.sub]);return e.permissions=a.rows.map((e=>e.name)),e}catch(e){throw{statusCode:403,message:"Invalid Authentication Token"}}},new((t=void 0)||(t=Promise))((function(e,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(n){var r;n.done?e(n.value):(r=n.value,r instanceof t?r:new t((function(e){e(r)}))).then(i,a)}c((o=o.apply(n,r||[])).next())}));var n,r,t,o},S=require("fs/promises");var v=r.n(S);const C=require("winston");var R=r.n(C);const N=require("path");var T=r.n(N);require("child_process"),require("util"),require("dotenv/config");let O=null;const L=()=>{if(!O&&((()=>{const e=(()=>{switch(process.env.LOG_LEVEL){case"1":return"info";case"2":return"debug";default:return"silent"}})(),n=R().format.combine(R().format.timestamp({format:"DD/MM/YYYY HH:mm:ss"}),R().format.printf((({timestamp:e,level:n,message:r})=>("object"==typeof r&&(r=JSON.stringify(r,null,2)),`${e} [${n}]: ${r}`))));process.env.LOG_FILE,O=R().createLogger({level:e,format:n,transports:[new(R().transports.Console)],silent:"silent"===e}),O.console=n=>{console.log(n),"info"!==e&&"debug"!==e||O.info(n)}})(),!O))throw new Error("Unable to initialize logger");return O},$=require("axios");var I=r.n($);const A=new class{constructor(){this.endpoint=process.env.GITHUB_GRAPHQL_ENDPOINT||"https://api.github.com/graphql",this.token=process.env.GITHUB_TOKEN||""}request(e,n){return r=this,t=void 0,s=function*(){try{return(yield I().post(this.endpoint,{query:e,variables:n},{headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"}})).data.data}catch(e){throw console.error("GraphQL request failed:",e),e}},new((o=void 0)||(o=Promise))((function(e,n){function i(e){try{c(s.next(e))}catch(e){n(e)}}function a(e){try{c(s.throw(e))}catch(e){n(e)}}function c(n){var r;n.done?e(n.value):(r=n.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,a)}c((s=s.apply(r,t||[])).next())}));var r,t,o,s}},w=require("isomorphic-git"),P=require("fs");var b=r.n(P);const k=require("isomorphic-git/http/node");var D=r.n(k),U=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const F=L();function q(e,n){return U(this,void 0,void 0,(function*(){if(!M(n))return F.info("Invalid file path"),null;const r=T().join(process.env.tmpDir,"lodash");try{return yield b().promises.mkdir(r,{recursive:!0}),F.debug(`Cloning repository from ${e} to ${r}`),yield w.clone({fs:b(),http:D(),dir:r,url:e,singleBranch:!0,depth:1}),F.info(`Repository cloned to ${r}`),r}catch(e){return e.message.includes("already exists")?(F.info(`Repository already cloned to ${r}`),r):(F.debug("Error cloning repository:",e),null)}}))}function x(e){return U(this,void 0,void 0,(function*(){if(!M(e))return void F.info(`Invalid repository name for deletion: ${e}`);const n=T().join(process.env.tmpDir,e);try{F.debug(`Attempting to delete repository directory: ${n}`),yield v().rm(n,{recursive:!0,force:!0}),F.info(`Successfully deleted repository directory: ${n}`)}catch(e){F.error(`Error deleting repository directory ${n}: ${e.message}`)}}))}function M(e){const n=T().resolve(e);return T().isAbsolute(n)&&!e.includes("..")}function B(e){return U(this,void 0,void 0,(function*(){let n=0,r=0;try{const t=(yield function e(n){return U(this,void 0,void 0,(function*(){const r=yield b().promises.readdir(n,{withFileTypes:!0}),t=yield Promise.all(r.map((r=>{const t=T().resolve(n,r.name);return r.isDirectory()?e(t):Promise.resolve([t])})));return Array.prototype.concat(...t)}))}(e)).filter((e=>e.endsWith(".js")||e.endsWith(".ts")));for(const e of t){const t=yield j(e);n+=t,r+=t}}catch(e){console.error(`Error calculating lines of code: ${e.message}`)}return{totalLinesCorrectness:n,totalLinesRamp:r}}))}function j(e){return new Promise(((n,r)=>{let t=0;b().createReadStream(e).on("data",(e=>{let n=-1;t--;do{n=e.indexOf(10,n+1),t++}while(-1!==n)})).on("end",(()=>{n(t)})).on("error",(e=>{r(e)}))}))}s().config();var G=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const W=L();function J(e){return G(this,void 0,void 0,(function*(){const n=e.trim(),r=/github\.com\/(?<owner>[^/]+)\/(?<packageName>[^/]+)/;return n.includes("npmjs.com")?function(e,n,r){var t;return G(this,void 0,void 0,(function*(){W.info("Handling NPM URL");const o=e.match(n);if(!(null===(t=null==o?void 0:o.groups)||void 0===t?void 0:t.packageName))return null;const s=o.groups.packageName;try{const e=yield function(e,n){return G(this,void 0,void 0,(function*(){const r=yield fetch(`https://registry.npmjs.org/${e}`),t=yield r.json();if("object"!=typeof t||null===t||!("repository"in t)||"string"!=typeof t.repository.url)throw new Error("Invalid data format");let o=t.repository.url;return o=o.replace(/^git\+/,"").replace(/\.git$/,""),o.match(n)}))}(s,r);if(null==e?void 0:e.groups)return W.info(`RepoURL: ${e.input}`),W.info(`Owner: ${e.groups.owner}, Package: ${e.groups.packageName}`),{packageName:e.groups.packageName,owner:e.groups.owner}}catch(e){W.info(`Error fetching NPM package: ${e}`)}return null}))}(n,/npmjs\.com\/package\/(?<packageName>[^/]+)/,r):n.includes("github.com")?function(e,n){W.info("Handling GitHub URL");const r=e.match(n);return(null==r?void 0:r.groups)?{packageName:r.groups.packageName,owner:r.groups.owner}:(W.info("Invalid GitHub URL"),null)}(n,r):(W.info("Invalid URL"),null)}))}var Y=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const H=L(),V=new Set(["MIT","Apache-2.0","ISC","BSD-2-Clause","BSD-3-Clause","0BSD","Academic Free License v3.0","AFL-3.0","Artistic License 2.0","Artistic-2.0","Boost Software License 1.0","BSL-1.0","BSD-4-Clause","BSD-3-Clause-Clear","Creative Commons license family","CC","Creative Commons Zero v1.0 Universal","CC0-1.0","Creative Commons Attribution 4.0","CC-BY-4.0","Creative Commons Attribution ShareAlike 4.0","CC-BY-SA-4.0","Do What The F*ck You Want To Public License","WTFPL","Educational Community License v2.0","ECL-2.0","Eclipse Public License 1.0","EPL-1.0","Eclipse Public License 2.0","EPL-2.0","European Union Public License 1.1","EUPL-1.1","GNU Affero General Public License v3.0","AGPL-3.0","GNU General Public License v2.0","GPL-2.0","GNU General Public License v3.0","GPL-3.0","GNU Lesser General Public License v2.1","LGPL-2.1","GNU Lesser General Public License v3.0","LGPL-3.0","LaTeX Project Public License v1.3c","LPPL-1.3c","Microsoft Public License","MS-PL","Mozilla Public License 2.0","MPL-2.0","Open Software License 3.0","OSL-3.0","PostgreSQL License","PostgreSQL","SIL Open Font License 1.1","OFL-1.1","University of Illinois/NCSA Open Source License","NCSA","The Unlicense","Zlib","zLib License"]);function z(e,n,r){return Y(this,void 0,void 0,(function*(){const t=yield function(e,n){return Y(this,void 0,void 0,(function*(){try{const r=(yield A.request("\n  query getLicenseInfo($repoOwner: String!, $repoName: String!) {\n    repository(owner: $repoOwner, name: $repoName) {\n      licenseInfo {\n        key\n        name\n        spdxId\n        url\n      }\n    }\n  }\n",{repoOwner:e,repoName:n})).repository.licenseInfo.spdxId;return H.debug("restLicense: ",r),V.has(r)?r:null}catch(e){return H.info("Error retrieving license information:",e),null}}))}(e,n);if(t)return H.info("License found in GraphQL"),1;if(!r)return H.info("Could not calculate license score: No repository directory provided"),0;const o=yield function(e){return Y(this,void 0,void 0,(function*(){try{const n=T().join(e,"README.md"),r=yield(0,S.readFile)(n,"utf8");for(const e of V)if(new RegExp(`\\b${e}\\b`,"i").test(r))return e;return null}catch(e){return H.info(`README.md not found or could not be read: ${e}`),null}}))}(r);if(o)return H.info("License found in README.md"),1;const s=yield function(e){return Y(this,void 0,void 0,(function*(){try{const n=T().join(e,"package.json"),r=yield(0,S.readFile)(n,"utf8"),t=JSON.parse(r).license;return V.has(t)?t:null}catch(e){return H.info(`package.json not found or could not be read: ${e}`),null}}))}(r);return s?(H.info("License found in package.json"),1):(H.info("No license found"),0)}))}const Q=require("date-fns");var K=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const X=L();function Z(e,n,r,t,o=50){return K(this,void 0,void 0,(function*(){try{const s=yield A.request('\n  query getForksAndPRs($repoOwner: String!, $repoName: String!, $firstForks: Int!) {\n    repository(owner: $repoOwner, name: $repoName) {\n      forks(first: $firstForks) {\n        edges {\n          node {\n            owner {\n              login\n            }\n            createdAt\n            pullRequests(first: 1) {\n              nodes {\n                createdAt\n                author {\n                  login\n                }\n              }\n            }\n            issues(first: 1) {\n              nodes {\n                createdAt\n                author {\n                  login\n                }\n              }\n            }\n            refs(refPrefix: "refs/heads/", first: 1) {\n              nodes {\n                target {\n                  ... on Commit {\n                    history(first: 1) {\n                      edges {\n                        node {\n                          committedDate\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n      object(expression: "HEAD:README.md") {\n        ... on Blob {\n          id\n        }\n      }\n      contributing: object(expression: "HEAD:CONTRIBUTING.md") {\n        ... on Blob {\n          id\n        }\n      }\n    }\n  }\n',{repoOwner:e,repoName:n,firstForks:o}),i=yield function(e){return K(this,void 0,void 0,(function*(){let n=0,r=0;return e.repository.forks.edges.forEach((({node:e})=>{const t=new Date(e.createdAt),o=e.pullRequests.nodes.length>0?new Date(e.pullRequests.nodes[0].createdAt):null,s=e.issues.nodes.length>0?new Date(e.issues.nodes[0].createdAt):null,i=[e.refs.nodes.length>0?new Date(e.refs.nodes[0].target.history.edges[0].node.committedDate):null,o,s].filter((e=>e&&e>=t)).filter(Boolean).reduce(((e,n)=>n&&(!e||n<e)?n:e),null);if(i){const e=(0,Q.differenceInDays)(i,t);n+=e,r++}})),X.debug(`Total days: ${n}, Forks with activity: ${r}`),r>0?n/r:0}))}(s),a=yield function(e,n,r){return K(this,void 0,void 0,(function*(){const t=e.repository.object,o=e.repository.contributing;return t&&o?(X.debug(`Found README and CONTRIBUTING for repo ${n}/${r}`),1):t||o?(X.debug(`Found README or CONTRIBUTING for repo ${n}/${r}`),.9):(X.debug(`No README or CONTRIBUTING found for repo ${n}/${r}`),.8)}))}(s,e,n),c=r?yield function(e,n){return K(this,void 0,void 0,(function*(){try{return X.debug(`Lines of code: ${n}`),n<=5e3?7:n<=1e4?10:n<=5e4?14:n<=1e5?21:n<=5e5?30:n<=1e6?45:60}catch(e){X.info("Error calculating target time:",e)}return 21}))}(0,t):21,u=c/Math.log(1.05),l=Math.max(Math.exp(-(i-c)/u),.3),d=Math.min(1,l*a);return X.debug(`Parts of the Ramp Up score: Main part: ${l}, Constant: ${u}, Documentation Weight: ${a}, Target Time: ${c}`),X.debug(`Ramp Up score for ${e}/${n}: ${d}`),d}catch(e){return X.info("Error fetching forks and PRs:",e),0}}))}const ee=L();function ne(e,n){return r=this,t=void 0,s=function*(){try{const r=yield A.request("\n  query getRepoData($repoOwner: String!, $repoName: String!, $firstIssues: Int!) {\n    repository(owner: $repoOwner, name: $repoName) {\n      issues(first: $firstIssues, states: CLOSED) {\n        edges {\n          node {\n            createdAt\n            closedAt\n          }\n        }\n      }\n      allIssues: issues {\n        totalCount\n      }\n      totalClosedIssues: issues(states: CLOSED) {\n        totalCount\n      }\n    }\n  }\n",{repoOwner:e,repoName:n,firstIssues:100}),t=function(e){if(0===e.length)return-1;const n=e.map((e=>{const n=new Date(e.node.createdAt),r=new Date(e.node.closedAt);return(0,Q.differenceInDays)(r,n)}));n.sort(((e,n)=>e-n));const r=Math.floor(n.length/2);return n.length%2!=0?n[Number(r)]:(n[r-1]+n[Number(r)])/2}(r.repository.issues.edges);if(-1===t)return ee.debug(`For repository ${e}/${n}, no issues found, assigning score 0.5`),.5;const o=0==t?1:Math.min(1,7/t),s=r.repository.allIssues.totalCount,i=r.repository.totalClosedIssues.totalCount/s,a=o*i;return ee.debug(`Responsive maintainer score for ${e}/${n}: ${a} with median response time: ${t} days, closure rate: ${i}`),a}catch(e){return ee.info("Error calculating responsive maintainer score:",e),0}},new((o=void 0)||(o=Promise))((function(e,n){function i(e){try{c(s.next(e))}catch(e){n(e)}}function a(e){try{c(s.throw(e))}catch(e){n(e)}}function c(n){var r;n.done?e(n.value):(r=n.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,a)}c((s=s.apply(r,t||[])).next())}));var r,t,o,s}const re=require("eslint");var te=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const oe=L();function se(e,n){return te(this,void 0,void 0,(function*(){if(console.log("start calculateCorrectness"),!e)return oe.info("Could not calculate correctness score: No repository directory provided"),0;const r=yield function(e,n){return te(this,void 0,void 0,(function*(){try{const r=new re.ESLint({ignore:!1,overrideConfigFile:T().resolve("eslint.config.mjs")}),t="**/*.{js,ts,tsx}",o=yield r.lintFiles([t]);let s=0,i=0;for(const e of o)s+=e.errorCount,i+=e.warningCount;if(0===n)return oe.debug(`No lines of code found in ${e}`),0;const a=Math.max(0,Math.min(1,1-(2*s+i)/n));return oe.debug(`ESLint errors: ${s}, warnings: ${i}, total lines: ${n}, final score: ${a} for ${e}`),a}catch(e){return oe.info(`Failed to calculate ESLint score: ${e}`),0}}))}(e,n);return r}))}const ie=L();function ae(e,n){return r=this,t=void 0,s=function*(){try{const r=new Date((new Date).setMonth((new Date).getMonth()-30)).toISOString();let t=!0,o=null;const s=new Map;for(;t;){const i=(yield A.request("\n  query getCommits($repoOwner: String!, $repoName: String!, $since: GitTimestamp!, $after: String) {\n    repository(owner: $repoOwner, name: $repoName) {\n      defaultBranchRef {\n        target {\n          ... on Commit {\n            history(since: $since, first: 100, after: $after) {\n              edges {\n                node {\n                  author {\n                    user {\n                      login\n                    }\n                  }\n                  committedDate\n                }\n              }\n              pageInfo {\n                endCursor\n                hasNextPage\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n",{repoOwner:e,repoName:n,since:r,after:o})).repository.defaultBranchRef.target.history;i.edges.forEach((({node:e})=>{var n;const r=null===(n=e.author.user)||void 0===n?void 0:n.login;r&&s.set(r,(s.get(r)||0)+1)})),o=i.pageInfo.endCursor,t=i.pageInfo.hasNextPage}const i=function(e){const n=Array.from(e.values());n.sort(((e,n)=>e-n));const r=n.length;if(0===r)return 0;const t=Math.floor(.9*r),o=n[Number(t)],s=n.filter((e=>e>=o)).length;return Math.min(1,Math.max(Math.round(.05*s*100)/100,0))}(s);return ie.debug(`Bus factor score for ${e}/${n}: ${i}`),i}catch(e){return ie.info("Error calculating bus factor score:",e),0}},new((o=void 0)||(o=Promise))((function(e,n){function i(e){try{c(s.next(e))}catch(e){n(e)}}function a(e){try{c(s.throw(e))}catch(e){n(e)}}function c(n){var r;n.done?e(n.value):(r=n.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,a)}c((s=s.apply(r,t||[])).next())}));var r,t,o,s}var ce=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const ue=L();function le(e,n,r=null){return ce(this,void 0,void 0,(function*(){return yield A.request("\n  query GetPullRequests($repoOwner: String!, $repoName: String!) {\n    repository(owner: $repoOwner, name: $repoName) {\n      pullRequests(first: 100) {\n        edges {\n          node {\n            additions  # Total lines of code added in the pull request\n            reviews {\n              totalCount  # Number of reviews for the pull request\n            }\n          }\n        }\n       \n      }\n    }\n  }\n",{repoOwner:e,repoName:n,after:r})}))}function de(e,n){return ce(this,void 0,void 0,(function*(){try{let r=0,t=0,o=null,s=!0;for(;s;){const i=(yield le(e,n,o)).repository.pullRequests;i.edges.forEach((({node:e})=>{r+=e.additions,e.reviews.totalCount>0&&(t+=e.additions)})),s=i.pageInfo.hasNextPage,o=i.pageInfo.endCursor,yield new Promise((e=>setTimeout(e,1e3)))}if(0===r)return 0;const i=t/r;return ue.debug(`Code Review Fraction Metric for ${e}/${n}: ${i}`),i}catch(e){return ue.info("Error calculating code review fraction metric:",e),0}}))}var pe=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};function Ee(e){return null!==i.valid(e)}function ge(e,n){return pe(this,void 0,void 0,(function*(){const r={owner:e,name:n},t=yield function(e){return pe(this,void 0,void 0,(function*(){const{owner:n,name:r}=e,t={owner:n,name:r},o=process.env.GITHUB_TOKEN;if(!o)return console.error("Error: GITHUB_TOKEN is not set in environment variables."),null;try{const e=yield I().post("https://api.github.com/graphql",{query:"\n    query($owner: String!, $name: String!) {\n      repository(owner: $owner, name: $name) {\n        defaultBranchRef {\n          name\n        }\n      }\n    }\n  ",variables:t},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`}});if(e.data.errors)return console.error(`GraphQL Errors for ${n}/${r}:`,JSON.stringify(e.data.errors,null,2)),null;const s=e.data.data.repository;return s&&s.defaultBranchRef?s.defaultBranchRef.name:(console.error(`Default branch not found for ${n}/${r}.`),null)}catch(e){return e.response?(console.error(`HTTP Error fetching default branch for ${n}/${r}:`,e.response.status,e.response.statusText),console.error("Response data:",e.response.data)):console.error(`Error fetching default branch for ${n}/${r}:`,e.message),null}}))}(r);if(!t)return console.log(`${r.owner}/${r.name}: Unable to determine the default branch.`),0;const o=yield function(e,n){return pe(this,void 0,void 0,(function*(){const{owner:r,name:t}=e,o={owner:r,name:t,expression:`${n}:package.json`},s=process.env.GITHUB_TOKEN;try{const e=yield I().post("https://api.github.com/graphql",{query:"\n    query($owner: String!, $name: String!, $expression: String!) {\n      repository(owner: $owner, name: $name) {\n        object(expression: $expression) {\n          ... on Blob {\n            text\n          }\n        }\n      }\n    }\n  ",variables:o},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}});if(e.data.errors)return console.error(`GraphQL Errors for ${r}/${t}:`,JSON.stringify(e.data.errors,null,2)),null;const i=e.data.data.repository.object;return i&&i.text?JSON.parse(i.text):(console.error(`No package.json found for ${r}/${t} in branch ${n}.`),null)}catch(e){return e.response?(console.error(`HTTP Error fetching package.json for ${r}/${t}:`,e.response.status,e.response.statusText),console.error("Response data:",e.response.data)):console.error(`Error fetching package.json for ${r}/${t}:`,e.message),null}}))}(r,t);if(o){const e=function(e){const n=Object.assign(Object.assign({},e.dependencies),e.devDependencies),r=Object.keys(n).length;return 0===r?0:Object.values(n).filter(Ee).length/r}(o);return console.log(`${r.owner}/${r.name}: ${e.toFixed(2)}% of dependencies are pinned.`),e}return console.log(`${r.owner}/${r.name}: Unable to fetch package.json.`),0}))}o.config();var fe=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};const ye=L();function me(e){return fe(this,void 0,void 0,(function*(){const n=Date.now();try{const r=yield e();return{score:r,latency:(Date.now()-n)/1e3}}catch(e){return ye.info(`Error calculating score: ${e}`),{score:0,latency:(Date.now()-n)/1e3}}}))}const _e=require("crypto");var he=r.n(_e);function Se(e,n){return r=this,t=void 0,s=function*(){const r=yield function(e){return G(this,void 0,void 0,(function*(){const n=yield J(e);return n?{url:e,owner:n.owner,repo:n.packageName}:null}))}(e);if(!r)return null;const t=r.repo,o=r.owner,s=r.url,i=yield d.query("SELECT \n    p.id, \n    p.name, \n    p.owner, \n    p.version,\n    p.url,\n    pr.bus_factor, \n    pr.bus_factor_latency, \n    pr.correctness, \n    pr.correctness_latency, \n    pr.ramp_up, \n    pr.ramp_up_latency, \n    pr.responsive_maintainer, \n    pr.responsive_maintainer_latency, \n    pr.license_score, \n    pr.license_score_latency, \n    pr.good_pinning_practice, \n    pr.good_pinning_practice_latency, \n    pr.pull_request, \n    pr.pull_request_latency, \n    pr.net_score, \n    pr.net_score_latency\nFROM \n    packages p\nJOIN \n    package_ratings pr ON p.id = pr.package_id\nWHERE \n    p.name = $1 \n    AND p.owner = $2;\n",[t,o]);if(i.rows.length>0){const e=i.rows[0];return{ID:e.id,NAME:e.name,OWNER:e.owner,VERSION:e.version,URL:e.url,NET_SCORE:e.net_score,RAMP_UP_SCORE:e.ramp_up_score,CORRECTNESS_SCORE:e.correctness_score,BUS_FACTOR_SCORE:e.bus_factor_score,RESPONSIVE_MAINTAINER_SCORE:e.responsive_maintainer_score,LICENSE_SCORE:e.license_score,PULL_REQUESTS_SCORE:e.pull_requests_score,PINNED_DEPENDENCIES_SCORE:e.pinned_dependencies_score,NET_SCORE_LATENCY:e.net_score_latency,RAMP_UP_SCORE_LATENCY:e.ramp_up_score_latency,CORRECTNESS_SCORE_LATENCY:e.correctness_score_latency,BUS_FACTOR_SCORE_LATENCY:e.bus_factor_score_latency,RESPONSIVE_MAINTAINER_SCORE_LATENCY:e.responsive_maintainer_score_latency,LICENSE_SCORE_LATENCY:e.license_score_latency,PULL_REQUESTS_SCORE_LATENCY:e.pull_requests_score_latency,PINNED_DEPENDENCIES_SCORE_LATENCY:e.pinned_dependencies_score_latency}}const a=`https://raw.githubusercontent.com/${o}/${t}/main/package.json`,c=yield fetch(a,{headers:{Authorization:`Bearer ${process.env.GITHUB_TOKEN}`,Accept:"application/vnd.github.v3+json"}});if(!c.ok)throw new Error("Failed to fetch package.json from GitHub");const u=(yield c.json()).version,l=yield function(e,n){return fe(this,void 0,void 0,(function*(){let r=[];e?r=yield function(e){return G(this,void 0,void 0,(function*(){if(!M(e))return W.info("Invalid file path"),[];let n;try{n=yield v().readFile(e,"utf-8")}catch(e){return W.info(`Error reading file: ${e}`),[]}if(!n)return W.info("Empty file"),[];const r=n.trim().split("\n"),t=[];for(const e of r){W.info(`Working with URL: ${e}`);const n=yield J(e);n?t.push(Object.assign(Object.assign({},n),{url:e})):W.info("Invalid URL")}return W.info(`Results: ${JSON.stringify(t)}`),t}))}(e):n&&(r=[{packageName:n.repo,owner:n.owner,url:n.url}]);for(const{packageName:e,owner:n,url:t}of r){const r=Date.now(),o=yield q(`https://github.com/${n}/${e}`,e);let s=0,i=0;if(o)try{const e=yield B(o);s=e.totalLinesCorrectness,i=e.totalLinesRamp,console.log("Total Lines Correctness:",e.totalLinesCorrectness),console.log("Total Lines Ramp:",e.totalLinesRamp)}catch(e){ye.info(`Error calculating lines of code: ${e.message}`)}const[a,c,u,l,d,p,E]=yield Promise.all([me((()=>z(n,e,o))),me((()=>Z(n,e,o,i))),me((()=>ne(n,e))),me((()=>ae(n,e))),me((()=>se(o,s))),me((()=>de(n,e))),me((()=>ge(n,e)))]),{score:g,latency:f}=a,{score:y,latency:m}=c,{score:_,latency:h}=u,{score:S,latency:v}=l,{score:C,latency:R}=d,{score:N,latency:T}=p,{score:O,latency:L}=E,$=.25*g+.1*y+.15*_+.15*S+.25*C+.05*N+.05*O,I=(Date.now()-r)/1e3;return ye.console(JSON.stringify({URL:t.trim(),NetScore:parseFloat($.toFixed(2)),NetScore_Latency:parseFloat(I.toFixed(3)),RampUp:parseFloat(y.toFixed(2)),RampUp_Latency:parseFloat(m.toFixed(3)),Correctness:parseFloat(C.toFixed(2)),Correctness_Latency:parseFloat(R.toFixed(3)),BusFactor:parseFloat(S.toFixed(2)),BusFactor_Latency:parseFloat(v.toFixed(3)),ResponsiveMaintainer:parseFloat(_.toFixed(2)),ResponsiveMaintainer_Latency:parseFloat(h.toFixed(3)),License:parseFloat(g.toFixed(2)),License_Latency:parseFloat(f.toFixed(3)),CodeReviewFraction:parseFloat(N.toFixed(2)),CodeReviewFraction_Latency:parseFloat(T.toFixed(3)),DependencyPinning:parseFloat(O.toFixed(2)),DependencyPinning_Latency:parseFloat(L.toFixed(3))})),o&&(yield x(e)),{URL:t.trim(),NetScore:parseFloat($.toFixed(2)),NetScore_Latency:parseFloat(I.toFixed(3)),RampUp:parseFloat(y.toFixed(2)),RampUp_Latency:parseFloat(m.toFixed(3)),Correctness:parseFloat(C.toFixed(2)),Correctness_Latency:parseFloat(R.toFixed(3)),BusFactor:parseFloat(S.toFixed(2)),BusFactor_Latency:parseFloat(v.toFixed(3)),ResponsiveMaintainer:parseFloat(_.toFixed(2)),ResponsiveMaintainer_Latency:parseFloat(h.toFixed(3)),License:parseFloat(g.toFixed(2)),License_Latency:parseFloat(f.toFixed(3)),CodeReviewFraction:parseFloat(N.toFixed(2)),CodeReviewFraction_Latency:parseFloat(T.toFixed(3)),DependencyPinning:parseFloat(O.toFixed(2)),DependencyPinning_Latency:parseFloat(L.toFixed(3))}}}))}(void 0,r);if(!l)return null;const p=l.NetScore,E=l.RampUp,g=l.Correctness,f=l.BusFactor,y=l.ResponsiveMaintainer,m=l.License,_=l.CodeReviewFraction,h=l.DependencyPinning;return{ID:n||"",NAME:t,OWNER:o,VERSION:u,URL:s,NET_SCORE:p,RAMP_UP_SCORE:E,CORRECTNESS_SCORE:g,BUS_FACTOR_SCORE:f,RESPONSIVE_MAINTAINER_SCORE:y,LICENSE_SCORE:m,PULL_REQUESTS_SCORE:_,NET_SCORE_LATENCY:l.NetScore_Latency,PINNED_DEPENDENCIES_SCORE:h,RAMP_UP_SCORE_LATENCY:l.RampUp_Latency,CORRECTNESS_SCORE_LATENCY:l.Correctness_Latency,BUS_FACTOR_SCORE_LATENCY:l.BusFactor_Latency,RESPONSIVE_MAINTAINER_SCORE_LATENCY:l.ResponsiveMaintainer_Latency,LICENSE_SCORE_LATENCY:l.License_Latency,PULL_REQUESTS_SCORE_LATENCY:l.CodeReviewFraction_Latency,PINNED_DEPENDENCIES_SCORE_LATENCY:l.DependencyPinning_Latency}},new((o=void 0)||(o=Promise))((function(e,n){function i(e){try{c(s.next(e))}catch(e){n(e)}}function a(e){try{c(s.throw(e))}catch(e){n(e)}}function c(n){var r;n.done?e(n.value):(r=n.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,a)}c((s=s.apply(r,t||[])).next())}));var r,t,o,s}L();const ve=()=>{console.log("Generating id");const e=he().randomBytes(8);let n=BigInt(`0x${e.toString("hex")}`);return n%=BigInt("9223372"),console.log(`Generated package id ${n.toString()} successfully`),n.toString()},Ce=require("adm-zip");var Re=r.n(Ce);const Ne=require("bcrypt");var Te=r.n(Ne),Oe=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};L();function Le(e){let n=null;const r=[/^git:\/\/([^/]+)\/([^/]+)\/([^/]+)\.git$/,/^git@([^:]+):([^/]+)\/([^/]+)\.git$/,/^ssh:\/\/git@([^/]+)\/([^/]+)\/([^/]+)\.git$/,/^https:\/\/([^/]+)\/([^/]+)\/([^/]+)(\.git)?$/];for(const t of r){const r=t.exec(e);if(r){n=`https://${r[1]}/${r[2]}/${r[3]}`;break}}if(!n)throw new Error(`Unrecognized Git URL format: ${e}`);return n}function $e(e){console.log("Debloating package content...");const n=new(Re())(e);return n.getEntries().forEach((e=>{(function(e){return e.entryName.endsWith(".md")||e.entryName.includes("tests/")})(e)&&n.deleteFile(e.entryName)})),n.toBuffer()}function Ie(e){return Oe(this,void 0,void 0,(function*(){try{return!0}catch(e){return console.error("JS Program Validation Error:",e),!1}}))}var Ae=function(e,n,r,t){return new(r||(r=Promise))((function(o,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((t=t.apply(e,n||[])).next())}))};L();s().config();const we=e=>{return n=void 0,r=void 0,o=function*(){const{httpMethod:n,path:r,pathParameters:t,queryStringParameters:o,headers:s,body:i}=e;try{if("/register"===r&&"POST"===n)return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n),console.log("User authenticated:",r)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to register users."});const{name:t,password:o,isAdmin:s=!1,groups:i=[],permissions:a=[]}=JSON.parse(e);if(!t||!o)return{statusCode:400,body:JSON.stringify({message:"Name and password are required."}),headers:{"Content-Type":"application/json"}};try{const e=yield Te().hash(o,10),n="\n      INSERT INTO users (name, password_hash, is_admin)\n      VALUES ($1, $2, $3)\n      RETURNING id\n    ",r=[t,e,s],c=(yield d.query(n,r)).rows[0].id;if(s){const e="SELECT id FROM permissions",n=(yield d.query(e)).rows.map((e=>e.id));for(const e of n){const n="\n          INSERT INTO user_permissions (user_id, permission_id)\n          VALUES ($1, $2)\n        ";yield d.query(n,[c,e])}const r="\n        INSERT INTO user_groups (user_id, group_id)\n        SELECT $1, id FROM groups WHERE name = 'admins'\n      ";yield d.query(r,[c])}else{for(const e of i){const n="\n          INSERT INTO user_groups (user_id, group_id)\n          SELECT $1, id FROM groups WHERE name = $2\n        ";yield d.query(n,[c,e])}for(const e of a){const n="\n          INSERT INTO user_permissions (user_id, permission_id)\n          SELECT $1, id FROM permissions WHERE name = $2\n        ";yield d.query(n,[c,e])}}return{statusCode:201,body:JSON.stringify({message:"User registered successfully!"}),headers:{"Content-Type":"application/json"}}}catch(e){return console.error("Error registering user:",e),"23505"===e.code?{statusCode:409,body:JSON.stringify({message:"User already exists."}),headers:{"Content-Type":"application/json"}}:{statusCode:500,body:JSON.stringify({message:"Internal server error."}),headers:{"Content-Type":"application/json"}}}})))(i||"{}",s);if("/sql"===r&&"POST"===n)return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}const{sql:t,params:o}=JSON.parse(e);if(!t||"string"!=typeof t)return y(400,{message:"SQL script is required and must be a string."});try{const e=yield d.query(t,o);return y(200,{result:e.rows})}catch(e){return console.error("SQL Execution Error:",e),y(500,{message:"Internal server error."})}})))(i||"{}",s);if("/authenticate"===r&&"PUT"===n)return yield(e=>Oe(void 0,void 0,void 0,(function*(){const{User:n,Secret:r}=JSON.parse(e),{name:t,isAdmin:o}=n,{password:s}=r;if(!t||"boolean"!=typeof o||!s)return y(400,{message:"Missing fields in AuthenticationRequest"});try{const e=yield(e=>u(void 0,void 0,void 0,(function*(){const n=yield l.query("SELECT * FROM users WHERE name = $1",[e]);return 0===n.rows.length?null:n.rows[0]})))(t);if(!e)return y(401,{message:"Invalid user or password."});if(!(yield Te().compare(s,e.password_hash)))return y(401,{message:"Invalid user or password."});const n=_().sign({sub:e.id,name:e.name,isAdmin:e.isAdmin},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN||"10h"});return y(200,{token:`bearer ${n}`})}catch(e){return console.error("Authentication Error:",e),y(500,{message:"Internal server error."})}})))(i||"{}");if("/packages"===r&&"POST"===n)return yield((e,n,r)=>Oe(void 0,void 0,void 0,(function*(){let t,o;try{t=yield h(n)}catch(e){return y(e.statusCode||403,{message:e.message||"Authentication failed."})}if(!t.permissions.includes("search"))return y(403,{message:"You do not have permission to search packages."});try{o=JSON.parse(e),console.log("Queries",o)}catch(e){return y(400,{message:"Invalid JSON format in request body."})}const s=r.offset?parseInt(r.offset):0;if(!Array.isArray(o))return y(400,{message:"Request body must be an array of PackageQuery."});try{const e=[];for(const n of o){const{Name:r,Version:t}=n;if(!r)return y(400,{message:"PackageQuery must include Name."});let o="SELECT * FROM packages WHERE name ILIKE $1";const s=[`%${r}%`],i=yield d.query(o,s);console.log(`Fetched packages for Name "${r}":`,i.rows);const c=i.rows.filter((e=>{if(!t)return!0;if(console.log(`Filtering package version: ${e.version} with Version filter: ${t}`),a().valid(t)){const n=a().eq(e.version,t);return console.log(`semver.eq(${e.version}, ${t}) = ${n}`),n}if(a().validRange(t)){const n=a().satisfies(e.version,t);return console.log(`semver.satisfies(${e.version}, ${t}) = ${n}`),n}return console.log(`Unsupported version format: ${t}`),!1}));console.log(`Filtered packages for Name "${r}" and Version "${t}":`,c),e.push(...c)}const n=Array.from(new Set(e.map((e=>e.id)))).map((n=>e.find((e=>e.id===n))));console.log("Unique Results after removing duplicates:",n);const r=n.slice(s,s+10),t=s+10<n.length?s+10:null,i={};return null!==t&&(i.offset=t.toString()),console.log("Paginated Results:",r),{statusCode:200,headers:i,body:JSON.stringify(r)}}catch(e){return console.error("List Packages Error:",e),y(500,{message:"Internal server error."})}})))(i||"[]",s,o||{});if("/reset"===r&&"DELETE"===n)return yield(e=>Oe(void 0,void 0,void 0,(function*(){let n;try{if(n=yield h(e),!n.isAdmin)return y(403,{message:"Admin privileges required."})}catch(e){return y(e.statusCode,{message:e.message})}try{return yield d.query("BEGIN"),yield d.query("TRUNCATE TABLE packages CASCADE;"),yield d.query("TRUNCATE TABLE package_history CASCADE;"),yield d.query("TRUNCATE TABLE package_ratings CASCADE;"),yield d.query("TRUNCATE TABLE dependencies CASCADE;"),yield d.query("TRUNCATE TABLE tracks CASCADE;"),yield d.query("TRUNCATE TABLE user_tracks CASCADE;"),yield d.query("TRUNCATE TABLE cost CASCADE;"),yield d.query("TRUNCATE TABLE userAuth CASCADE;"),yield d.query("DELETE FROM users WHERE name != $1",["ece30861defaultadminuser"]),yield d.query("COMMIT"),y(200,{message:"Registry is reset, only the default admin user is retained."})}catch(e){return yield d.query("ROLLBACK"),console.error("Reset Registry Error:",e),y(500,{message:"Internal server error."})}})))(s);if("/package/byRegEx"===r&&"POST"===n)return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.permissions.includes("search"))return y(403,{message:"You do not have permission to search packages."});const{RegEx:t}=JSON.parse(e);if(!t)return y(400,{message:"Missing RegEx field in PackageRegEx."});try{const e="\n      SELECT * FROM packages\n      WHERE name ~* $1 OR readme ~* $1\n    ",n=yield d.query(e,[t]);if(0===n.rows.length)return y(404,{message:"No package found under this regex."});const r=n.rows.map((e=>({Version:e.version,Name:e.name,ID:e.id})));return y(200,r)}catch(e){return console.error("Search Packages Error:",e),y(500,{message:"Internal server error."})}})))(i||"{}",s);if(r&&r.startsWith("/package/byName/")&&"GET"===n){const e=r.split("/").pop()||"";return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.permissions.includes("search"))return y(403,{message:"You do not have permission to search packages."});try{const n="\n      SELECT ph.*, u.name as user_name, u.is_admin\n      FROM package_history ph\n      JOIN packages p ON ph.package_id = p.id\n      JOIN users u ON ph.user_id = u.id\n      WHERE p.name ILIKE $1\n      ORDER BY ph.date DESC\n    ",r=yield d.query(n,[`%${e}%`]);if(0===r.rows.length)return y(404,{message:"No such package."});const t=r.rows.map((e=>({User:{name:e.user_name,isAdmin:e.is_admin},Date:e.date.toISOString(),PackageMetadata:{Name:e.name,Version:e.version,ID:e.package_id},Action:e.action})));return y(200,t)}catch(e){return console.error("Get Package History Error:",e),y(500,{message:"Internal server error."})}})))(e,s)}if("/package"===r&&"POST"===n)return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){var r;let t;try{t=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!t.permissions.includes("upload"))return y(403,{message:"You do not have permission to upload packages."});const o=JSON.parse(e),{Content:s,JSProgram:i,URL:a,debloat:c}=o;if(console.log("packageData",o),console.log("JSprog",i),!s&&!a||s&&a)return y(400,{message:"Either Content or URL must be set, but not both."});let u,l,E={},g={},m=null;E.ID=ve(),g.debloat=c||!1,g.JSProgram=i||null;try{if(s){const e=Buffer.from(s,"base64"),n=new(Re())(e).getEntries();let t=null;if(n.forEach((e=>{e.entryName.endsWith("package.json")&&(t=e.getData().toString("utf8"))})),!t)return y(400,{message:"No package.json found in zip"});if(u=JSON.parse(t),E.Name=u.name,E.Version=u.version,E.Owner=u.author,g.Content=s,m=e,g.URL=(null===(r=u.repository)||void 0===r?void 0:r.url)?Le(u.repository.url):`https://github.com/${u.author||"unknown-owner"}/${E.Name}`,c&&(m=$e(m)),(yield d.query("SELECT id FROM packages WHERE name = $1 AND version = $2;",[E.Name,E.Version])).rows.length>0)return y(409,{message:"Package exists already."});l=yield p(E,g)}else if(a){const e=Le(a),n=yield Se(e,E.ID);if(!n||n.NET_SCORE<.5)return y(424,{message:"Package disqualified due to low rating"});if(E.Name=n.NAME,E.Version=n.VERSION,g.URL=e,E.Owner=n.OWNER,(yield d.query("SELECT id FROM packages WHERE name = $1 AND version = $2;",[E.Name,E.Version])).rows.length>0)return y(409,{message:"Package exists already."});const r=yield fetch(`https://api.github.com/repos/${n.OWNER}/${n.NAME}/zipball/HEAD`,{headers:{Authorization:`Bearer ${process.env.GITHUB_TOKEN}`,Accept:"application/vnd.github.v3+json"}});if(!r.ok)return y(400,{message:"Could not get GitHub URL for zip package download"});const t=yield r.arrayBuffer();m=Buffer.from(t),c&&(m=$e(m)),l=yield p(E,g);const o="\n        INSERT INTO package_ratings \n          (package_id, net_score, ramp_up, correctness, \n           bus_factor, responsive_maintainer, license_score, \n           pull_request, good_pinning_practice, net_score_latency, \n           ramp_up_latency, correctness_latency, bus_factor_latency, \n           responsive_maintainer_latency, license_score_latency, \n           pull_request_latency, good_pinning_practice_latency) \n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17)\n      ",s=[n.ID,n.NET_SCORE,n.RAMP_UP_SCORE,n.CORRECTNESS_SCORE,n.BUS_FACTOR_SCORE,n.RESPONSIVE_MAINTAINER_SCORE,n.LICENSE_SCORE,n.PULL_REQUESTS_SCORE,n.PINNED_DEPENDENCIES_SCORE,n.NET_SCORE_LATENCY,n.RAMP_UP_SCORE_LATENCY,n.CORRECTNESS_SCORE_LATENCY,n.BUS_FACTOR_SCORE_LATENCY,n.RESPONSIVE_MAINTAINER_SCORE_LATENCY,n.LICENSE_SCORE_LATENCY,n.PULL_REQUESTS_SCORE_LATENCY,n.PINNED_DEPENDENCIES_SCORE_LATENCY];yield d.query(o,s)}else l={};if(i){if(!(yield Ie()))return y(400,{message:"Invalid JavaScript program"});g.JSProgram=i}let e;return m?(e=m.toString("base64"),yield f(E.ID,m),yield d.query("INSERT INTO package_history (package_id, user_id, action)\n       VALUES ($1, $2, $3)",[E.ID,t.sub,"CREATE"]),y(201,{metadata:{Name:E.Name,Version:E.Version,ID:E.ID},data:{Content:e||null,URL:g.URL||null,JSProgram:g.JSProgram||null}})):y(500,{message:"Package content buffer is empty, unable to upload."})}catch(e){return console.error("Create Package Error:",e),y(500,{message:"Internal server error."})}})))(i||"{}",s);if(r&&r.startsWith("/package/")&&r.endsWith("/rate")&&"GET"===n){const e=r.split("/")[2];return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(403,{message:"Authentication failed due to invalid or missing AuthenticationToken"})}if(!e)return y(400,{message:"Missing field(s) in PackageID."});try{const n="SELECT url FROM packages WHERE id = $1",r=yield d.query(n,[e]);if(0===r.rows.length)return y(500,{message:"The package rating system choked on at least one of the metrics."});const t=r.rows[0].url,o=yield Se(t,e);if(!o)return y(500,{message:"Failed to calculate metrics for the package."});const s="SELECT 1 FROM package_ratings WHERE package_id = $1";if((yield d.query(s,[e])).rows.length>0){const e="\n        UPDATE package_ratings\n        SET \n          bus_factor = $2, \n          bus_factor_latency = $3, \n          correctness = $4, \n          correctness_latency = $5, \n          ramp_up = $6, \n          ramp_up_latency = $7, \n          responsive_maintainer = $8, \n          responsive_maintainer_latency = $9, \n          license_score = $10, \n          license_score_latency = $11, \n          good_pinning_practice = $12, \n          good_pinning_practice_latency = $13, \n          pull_request = $14, \n          pull_request_latency = $15, \n          net_score = $16, \n          net_score_latency = $17\n        WHERE package_id = $1\n      ",n=[o.ID,o.BUS_FACTOR_SCORE,o.BUS_FACTOR_SCORE_LATENCY,o.CORRECTNESS_SCORE,o.CORRECTNESS_SCORE_LATENCY,o.RAMP_UP_SCORE,o.RAMP_UP_SCORE_LATENCY,o.RESPONSIVE_MAINTAINER_SCORE,o.RESPONSIVE_MAINTAINER_SCORE_LATENCY,o.LICENSE_SCORE,o.LICENSE_SCORE_LATENCY,o.PINNED_DEPENDENCIES_SCORE,o.PINNED_DEPENDENCIES_SCORE_LATENCY,o.PULL_REQUESTS_SCORE,o.PULL_REQUESTS_SCORE_LATENCY,o.NET_SCORE,o.NET_SCORE_LATENCY];yield d.query(e,n)}else{const e="\n        INSERT INTO package_ratings (\n          package_id, \n          bus_factor, \n          bus_factor_latency, \n          correctness, \n          correctness_latency, \n          ramp_up, \n          ramp_up_latency, \n          responsive_maintainer, \n          responsive_maintainer_latency, \n          license_score, \n          license_score_latency, \n          good_pinning_practice, \n          good_pinning_practice_latency, \n          pull_request, \n          pull_request_latency, \n          net_score, \n          net_score_latency\n        ) VALUES (\n          $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17\n        )\n      ",n=[o.ID,o.BUS_FACTOR_SCORE,o.BUS_FACTOR_SCORE_LATENCY,o.CORRECTNESS_SCORE,o.CORRECTNESS_SCORE_LATENCY,o.RAMP_UP_SCORE,o.RAMP_UP_SCORE_LATENCY,o.RESPONSIVE_MAINTAINER_SCORE,o.RESPONSIVE_MAINTAINER_SCORE_LATENCY,o.LICENSE_SCORE,o.LICENSE_SCORE_LATENCY,o.PINNED_DEPENDENCIES_SCORE,o.PINNED_DEPENDENCIES_SCORE_LATENCY,o.PULL_REQUESTS_SCORE,o.PULL_REQUESTS_SCORE_LATENCY,o.NET_SCORE,o.NET_SCORE_LATENCY];yield d.query(e,n)}return y(200,function(e){return{BusFactor:e.BUS_FACTOR_SCORE,BusFactorLatency:e.BUS_FACTOR_SCORE_LATENCY,Correctness:e.CORRECTNESS_SCORE,CorrectnessLatency:e.CORRECTNESS_SCORE_LATENCY,RampUp:e.RAMP_UP_SCORE,RampUpLatency:e.RAMP_UP_SCORE_LATENCY,ResponsiveMaintainer:e.RESPONSIVE_MAINTAINER_SCORE,ResponsiveMaintainerLatency:e.RESPONSIVE_MAINTAINER_SCORE_LATENCY,LicenseScore:e.LICENSE_SCORE,LicenseScoreLatency:e.LICENSE_SCORE_LATENCY,GoodPinningPractice:e.PINNED_DEPENDENCIES_SCORE,GoodPinningPracticeLatency:e.PINNED_DEPENDENCIES_SCORE_LATENCY,PullRequest:e.PULL_REQUESTS_SCORE,PullRequestLatency:e.PULL_REQUESTS_SCORE_LATENCY,NetScore:e.NET_SCORE,NetScoreLatency:e.NET_SCORE_LATENCY}}(o))}catch(e){return console.error("Error calculating package rating:",e),y(500,{message:"An error occurred while calculating the package rating."})}})))(e,s)}if(r&&r.startsWith("/package/")&&r.endsWith("/cost")&&"GET"===n){const e=r.split("/")[2];return yield((e,n,r)=>Oe(void 0,void 0,void 0,(function*(){let t;try{t=yield h(n)}catch(e){return y(403,{message:"Authentication failed due to invalid or missing AuthenticationToken"})}const o=r&&"true"===r.dependency;try{const n="\n      SELECT p.id, p.name, p.version, p.size_mb\n      FROM packages p\n      WHERE p.id = $1\n    ";if(0===(yield d.query(n,[e])).rows.length)return y(404,{message:"Package does not exist."});const r={};let t=0;const s=[e],i=new Set;for(;s.length>0;){const e=s.pop();if(i.has(e))continue;i.add(e);const n="SELECT * FROM packages WHERE id = $1",a=yield d.query(n,[e]);if(0===a.rows.length)continue;const c=a.rows[0];if(r[c.id]={standaloneCost:c.size_mb,totalCost:c.size_mb},t+=c.size_mb,o){const n="SELECT dependency_id FROM dependencies WHERE package_id = $1";(yield d.query(n,[e])).rows.forEach((e=>{i.has(e.dependency_id)||(s.push(e.dependency_id),t+=e.size_mb)}))}}if(o){let e=0;for(const n in r)e+=r[n].standaloneCost||0,r[n].totalCost=e}else r[e].totalCost=r[e].standaloneCost||0;return y(200,r)}catch(e){return console.error("Get Package Cost Error:",e),y(500,{message:"The package rating system choked on at least one of the metrics."})}})))(e,s,o||{})}if(r&&r.startsWith("/package/")&&"GET"===n){const e=r.split("/")[2];return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){if(!e||"string"!=typeof e||""===e.trim())return y(400,{message:"There is missing field(s) in the PackageID or it is formed improperly, or is invalid."});let r;console.log("getting packeage with ID",e);try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.permissions.includes("download"))return y(403,{message:"You do not have permission to download packages."});try{const n="SELECT * FROM packages WHERE id = $1",o=yield d.query(n,[e]);if(0===o.rows.length)return y(404,{message:"Package does not exist."});const s=o.rows[0];if(console.log(o.rows[0]),!s.content)try{const n=yield(t=e,E(void 0,void 0,void 0,(function*(){console.log("getPackageContent",t);const e={Bucket:process.env.S3_BUCKET,Key:`packages/${t}.zip`};return(yield g.getObject(e).promise()).Body.toString("base64")})));s.content=n}catch(e){return console.error("S3 Retrieval Error:",e),y(500,{message:"Failed to retrieve package content."})}const i="\n      INSERT INTO package_history (package_id, user_id, action)\n      VALUES ($1, $2, $3)\n    ";yield d.query(i,[e,r.sub,"DOWNLOAD"]);const a={metadata:{Name:s.name,Version:s.version,ID:s.id},data:{Content:s.content,JSProgram:s.js_program}};return y(200,a)}catch(e){return console.error("Retrieve Package Error:",e),y(500,{message:"Internal server error."})}var t})))(e,s)}if(r&&r.startsWith("/package/")&&"POST"===n){const e=r.split("/")[2];return yield((e,n,r)=>Oe(void 0,void 0,void 0,(function*(){let t;try{t=yield h(r)}catch(e){return y(e.statusCode,{message:e.message})}if(!t.permissions.includes("upload"))return y(403,{message:"You do not have permission to update packages."});const o=JSON.parse(n),{metadata:s,data:i}=o;if(s.ID!==e)return y(400,{message:"There is missing field(s) in the PackageID or it is formed improperly, or is invalid."});const a=yield d.query("select * from packages where name=$1",[o.metadata.Name]);if(0==a.rows.length)return y(404,{message:"Package does not exist."});if((yield d.query("SELECT id FROM packages WHERE name = $1 AND version = $2;",[s.Name,s.Version])).rows.length>0)return y(409,{message:"Package exists already."});console.log("Results");const[c,u,l]=o.metadata.Version.split("."),E=parseInt(c,10),g=parseInt(u,10),m=parseInt(l,10);console.log(E," ",g," ",m),console.log("Coming");for(let e=0;e<a.rows.length;e++){let[n,r,t]=a.rows[e].version.split("."),o=parseInt(n,10),s=parseInt(r,10),i=parseInt(t,10);if(o==E&&s==g&&i>m)return y(400,{message:"Invalid Version."})}(yield d.query("select * from packages where id=$1",[o.metadata.ID])).rows.length>0&&(o.metadata.ID=ve(),console.log("New ID"),console.log(o.metadata.ID));let _=null;try{if(o.data.Content){const e=Buffer.from(o.data.Content,"base64");new(Re())(e).getEntries();let n=o.metadata,r=o.data;_=e,r.debloat&&(_=$e(_)),yield p(n,r)}else if(o.data.URL){const e=Le(o.data.URL),n=yield Se(e,s.ID);if(!n||n.NET_SCORE<.5)return y(424,{message:"Package disqualified due to low rating"});if(s.Owner=n.OWNER,(yield d.query("SELECT id FROM packages WHERE name = $1 AND version = $2;",[s.Name,s.Version])).rows.length>0)return y(409,{message:"Package exists already."});const r=yield fetch(`https://api.github.com/repos/${n.OWNER}/${n.NAME}/zipball/HEAD`,{headers:{Authorization:`Bearer ${process.env.GITHUB_TOKEN}`,Accept:"application/vnd.github.v3+json"}});if(!r.ok)return y(400,{message:"Could not get GitHub URL for zip package download"});const t=yield r.arrayBuffer();_=Buffer.from(t),o.data.debloat&&(_=$e(_)),yield p(s,i),yield d.query("INSERT INTO package_ratings \n    (package_id, net_score, ramp_up, correctness, \n     bus_factor, responsive_maintainer, license_score, \n     pull_request, good_pinning_practice) \n    VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n    ",[n.ID,n.NET_SCORE,n.RAMP_UP_SCORE,n.CORRECTNESS_SCORE,n.BUS_FACTOR_SCORE,n.RESPONSIVE_MAINTAINER_SCORE,n.LICENSE_SCORE,n.PULL_REQUESTS_SCORE,n.PINNED_DEPENDENCIES_SCORE])}if(o.data.JSProgram){if(!(yield Ie(o.data.JSProgram)))return y(400,{message:"Invalid JavaScript program"});i.JSProgram=o.data.JSProgram}let e;return _?(e=_.toString("base64"),yield f(s.ID,_),yield d.query("INSERT INTO package_history (package_id, user_id, action)\n       VALUES ($1, $2, $3)",[s.ID,t.sub,"UPDATE"]),y(200,{message:"Version is updated."})):y(500,{message:"Package content buffer is empty, unable to upload."})}catch(e){return console.error("Create Package Error:",e),y(500,{message:"Internal server error."})}})))(e,i||"{}",s)}if(r&&r.startsWith("/package/")&&"DELETE"===n){const e=r.split("/")[2];return yield((e,n)=>Oe(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.permissions.includes("upload"))return y(403,{message:"You do not have permission to upload/delete packages."});try{const n="DELETE FROM packages WHERE id = $1 RETURNING *",o="\n    INSERT INTO package_history (package_id, user_id, action)\n    VALUES ($1, $2, $3)\n  ";yield d.query(o,[e,r.sub,"DELETE"]);const s=yield d.query(n,[e]);return 0===s.rows.length?y(404,{message:"Package does not exist."}):(s.rows[0]&&(yield(t=e,E(void 0,void 0,void 0,(function*(){const e={Bucket:process.env.S3_BUCKET,Key:`packages/${t}.zip`};yield g.deleteObject(e).promise()})))),y(200,{message:"Package is deleted."}))}catch(e){return console.error("Delete Package Error:",e),y(500,{message:"Internal server error."})}var t})))(e,s)}if("/tracks"===r&&"GET"===n)return yield(e=>Oe(void 0,void 0,void 0,(function*(){let n;try{n=yield h(e)}catch(e){return y(e.statusCode,{message:e.message})}try{const e="\n      SELECT t.track_name\n      FROM user_tracks ut\n      JOIN tracks t ON ut.track_id = t.id\n      WHERE ut.user_id = $1\n    ",r=(yield d.query(e,[n.sub])).rows.map((e=>e.track_name));return y(200,{plannedTracks:r})}catch(e){return console.error("Get Tracks Error:",e),y(500,{message:"The system encountered an error while retrieving the student's track information."})}})))(s);if("/groups"===r&&"POST"===n)return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to create groups."});const{name:t}=JSON.parse(e);if(!t)return{statusCode:400,body:JSON.stringify({message:"Group name is required."}),headers:{"Content-Type":"application/json"}};try{const e="\n      INSERT INTO groups (name)\n      VALUES ($1)\n      RETURNING id\n    ",n=[t],r=(yield d.query(e,n)).rows[0].id;return{statusCode:201,body:JSON.stringify({message:"Group created successfully!",groupId:r}),headers:{"Content-Type":"application/json"}}}catch(e){return console.error("Error creating group:",e),"23505"===e.code?{statusCode:409,body:JSON.stringify({message:"Group already exists."}),headers:{"Content-Type":"application/json"}}:{statusCode:500,body:JSON.stringify({message:"Internal server error."}),headers:{"Content-Type":"application/json"}}}})))(i||"{}",s);if("/permissions"===r&&"POST"===n)return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to create permissions."});const{name:t}=JSON.parse(e);if(!t)return{statusCode:400,body:JSON.stringify({message:"Permission name is required."}),headers:{"Content-Type":"application/json"}};try{const e="\n      INSERT INTO permissions (name)\n      VALUES ($1)\n      RETURNING id\n    ",n=[t],r=(yield d.query(e,n)).rows[0].id;return{statusCode:201,body:JSON.stringify({message:"Permission created successfully!",permissionId:r}),headers:{"Content-Type":"application/json"}}}catch(e){return console.error("Error creating permission:",e),"23505"===e.code?{statusCode:409,body:JSON.stringify({message:"Permission already exists."}),headers:{"Content-Type":"application/json"}}:{statusCode:500,body:JSON.stringify({message:"Internal server error."}),headers:{"Content-Type":"application/json"}}}})))(i||"{}",s);if(r&&r.startsWith("/users/")&&r.endsWith("/edit")&&"PUT"===n){const e=r.split("/")[2],n=parseInt(e);return yield((e,n,r)=>Ae(void 0,void 0,void 0,(function*(){let t;try{t=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!t.isAdmin)return y(403,{message:"Admin privileges required to edit user groups and permissions."});const{groups:o=[],permissions:s=[]}=JSON.parse(e);if(!r)return{statusCode:400,body:JSON.stringify({message:"User ID is required."}),headers:{"Content-Type":"application/json"}};try{yield d.query("BEGIN"),yield d.query("DELETE FROM user_groups WHERE user_id = $1",[r]),yield d.query("DELETE FROM user_permissions WHERE user_id = $1",[r]);for(const e of o){const n="\n        INSERT INTO user_groups (user_id, group_id)\n        SELECT $1, id FROM groups WHERE name = $2\n      ";yield d.query(n,[r,e])}for(const e of s){const n="\n        INSERT INTO user_permissions (user_id, permission_id)\n        SELECT $1, id FROM permissions WHERE name = $2\n      ";yield d.query(n,[r,e])}return yield d.query("COMMIT"),{statusCode:200,body:JSON.stringify({message:"User groups and permissions updated successfully."}),headers:{"Content-Type":"application/json"}}}catch(e){return yield d.query("ROLLBACK"),console.error("Error updating user groups and permissions:",e),y(500,{message:"Internal server error."})}})))(i||"{}",s,n)}if("/users/groups-permissions"===r&&"GET"===n)return yield(e=>Ae(void 0,void 0,void 0,(function*(){let n;try{n=yield h(e)}catch(e){return y(e.statusCode,{message:e.message})}if(!n.isAdmin)return y(403,{message:"Admin privileges required to retrieve user groups and permissions."});try{const e="SELECT id, name FROM groups",n=(yield d.query(e)).rows,r="SELECT id, name FROM permissions",t=(yield d.query(r)).rows;return{statusCode:200,body:JSON.stringify({groups:n,permissions:t}),headers:{"Content-Type":"application/json"}}}catch(e){return console.error("Error retrieving user groups and permissions:",e),y(500,{message:"Internal server error."})}})))(s);if(r&&r.startsWith("/users/")&&r.endsWith("/groups-permissions")&&"GET"===n){const e=r.split("/")[2];return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to retrieve user groups and permissions."});const t=parseInt(e);try{const e="\n      SELECT g.id, g.name\n      FROM user_groups ug\n      JOIN groups g ON ug.group_id = g.id\n      WHERE ug.user_id = $1\n    ",n=(yield d.query(e,[t])).rows,r="\n      SELECT p.id, p.name\n      FROM user_permissions up\n      JOIN permissions p ON up.permission_id = p.id\n      WHERE up.user_id = $1\n    ",o=(yield d.query(r,[t])).rows;return{statusCode:200,body:JSON.stringify({userGroups:n,userPermissions:o}),headers:{"Content-Type":"application/json"}}}catch(e){return console.error("Error retrieving user groups and permissions:",e),y(500,{message:"Internal server error."})}})))(e,s)}if(r&&r.startsWith("/users/")&&"DELETE"===n){const e=r.split("/")[2];return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to delete users."});try{const n="DELETE FROM users WHERE id = $1 RETURNING *";return 0===(yield d.query(n,[e])).rows.length?y(404,{message:"User does not exist."}):y(200,{message:"User deleted successfully."})}catch(e){return console.error("Error deleting user:",e),y(500,{message:"Internal server error."})}})))(e,s)}if(r&&r.startsWith("/groups/")&&"DELETE"===n){const e=r.split("/")[2];return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to delete groups."});try{const n="DELETE FROM groups WHERE id = $1 RETURNING *";return 0===(yield d.query(n,[e])).rows.length?y(404,{message:"Group does not exist."}):y(200,{message:"Group deleted successfully."})}catch(e){return console.error("Error deleting group:",e),y(500,{message:"Internal server error."})}})))(e,s)}if(r&&r.startsWith("/permissions/")&&"DELETE"===n){const e=r.split("/")[2];return yield((e,n)=>Ae(void 0,void 0,void 0,(function*(){let r;try{r=yield h(n)}catch(e){return y(e.statusCode,{message:e.message})}if(!r.isAdmin)return y(403,{message:"Admin privileges required to delete permissions."});try{const n="DELETE FROM permissions WHERE id = $1 RETURNING *";return 0===(yield d.query(n,[e])).rows.length?y(404,{message:"Permission does not exist."}):y(200,{message:"Permission deleted successfully."})}catch(e){return console.error("Error deleting permission:",e),y(500,{message:"Internal server error."})}})))(e,s)}return{statusCode:404,body:JSON.stringify({message:"Not Found"}),headers:{"Content-Type":"application/json"}}}catch(e){return console.error("Error handling request:",e),{statusCode:500,body:JSON.stringify({message:"Internal server error."}),headers:{"Content-Type":"application/json"}}}},new((t=void 0)||(t=Promise))((function(e,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(n){var r;n.done?e(n.value):(r=n.value,r instanceof t?r:new t((function(e){e(r)}))).then(i,a)}c((o=o.apply(n,r||[])).next())}));var n,r,t,o};module.exports=t})();