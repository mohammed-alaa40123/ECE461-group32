name: Deploy Lambda Function with Layer

on:
  push:
    branches:
      - single_lambda

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install zip tool
        run: sudo apt-get install zip -y

      # Step 1: Create Lambda Layer with Node Modules
      - name: Create Lambda Layer Directory and Install Dependencies
        run: |
          echo "Creating Lambda Layer directory and installing dependencies"
          mkdir -p backend/lambda-layer/nodejs
          cp backend/src/package.json backend/lambda-layer/nodejs/
          cd backend/lambda-layer/nodejs
          npm install --only=prod

      - name: Zip Lambda Layer
        run: |
          echo "Zipping Lambda Layer"
          cd backend/lambda-layer
          zip -r lambda-layer.zip nodejs

      # Step 2: Publish the Lambda Layer to AWS
      - name: Publish Lambda Layer
        uses: imehedi/actions-awscli-v2@latest
        with:
          args: "lambda publish-layer-version \
            --layer-name BackendDependenciesLayer \
            --description 'Lambda Layer with Node.js dependencies for Backend' \
            --zip-file fileb://backend/lambda-layer/lambda-layer.zip \
            --compatible-runtimes nodejs14.x nodejs16.x \
            --query 'LayerVersionArn' --output text"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "us-east-1"
        id: publish_layer

      # Step 3: Update the Lambda function to use the new Layer
      - name: Update Lambda Function to Use Layer
        uses: imehedi/actions-awscli-v2@latest
        with:
          args: "lambda update-function-configuration \
            --function-name arn:aws:lambda:us-east-1:438465151830:function:Get_S3_lambda \
            --layers ${{ steps.publish_layer.outputs.LayerVersionArn }}"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "us-east-1"

      # Step 4: Build Backend Code and Create Lambda Function Package
      - name: Build the Backend Code
        working-directory: backend/src
        run: |
          echo "Building backend code"
          npm run build

      # Step 5: Remove Dependencies and Create Zip for Lambda Function Code
      - name: Remove Dependencies and Create Zip for Lambda Function Code
        working-directory: backend/src
        run: |
          echo "Removing node_modules and creating zip for Lambda function"
          rm -rf node_modules
          zip -r ../../code.zip index.js package.json default.eslintrc.json

      # Step 6: Update Lambda function code with AWS CLI v2
      - name: Update Lambda Function Code with AWS CLI v2
        uses: imehedi/actions-awscli-v2@latest
        with:
          args: "lambda update-function-code \
            --function-name arn:aws:lambda:us-east-1:438465151830:function:Get_S3_lambda \
            --zip-file fileb://code.zip"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "us-east-1"
